# Отчет по валидации и значениям по умолчанию

## 1. Обзор текущей реализации

### Валидация
*   **Конфигурация:** Используется кастомная система на базе `BaseValidator` (`src/config/validators/`), которая проверяет типы данных и минимальные значения.
*   **API (DTO):** Используется `class-validator` в `ChatCompletionRequestDto`. Реализована проверка типов, обязательности полей и некоторых диапазонов (например, `temperature` 0-2).

### Значения по умолчанию
*   **В коде:** Частично реализованы в `router.config.ts` (например, `modelsFile`, `modelRequestsPerMinute`) и в `DEFAULT_CIRCUIT_BREAKER_CONFIG`.
*   **В файле конфигурации:** Основные значения заданы в `config.yaml`.

---

## 2. Выявленные проблемы и недостатки

### Отсутствие верхних лимитов (Upper Limits)
Большинство числовых параметров имеют проверку только на минимальное значение (`Min` или `>= 0`). Отсутствие верхних лимитов может привести к:
1.  **Ошибочным значениям:** Например, `retryDelay` в 1 000 000 мс заблокирует слот обработки.
2.  **Злоупотреблениям:** Слишком высокие значения `max_model_switches` или `max_tokens` могут перегрузить систему или привести к большим затратам.

**Конкретные примеры отсутствия лимитов:**
*   `maxModelSwitches` / `max_model_switches`
*   `maxSameModelRetries` / `max_same_model_retries`
*   `retryDelay` / `retry_delay`
*   `timeoutSecs` / `timeout_secs`
*   `modelRequestsPerMinute`
*   Параметры Circuit Breaker (`failureThreshold`, `cooldownPeriodMins`, и т.д.)

### Неполные значения по умолчанию в коде
Интерфейс `RoutingConfig` помечает поля `maxModelSwitches`, `maxSameModelRetries` и `timeoutSecs` как обязательные, но в `router.config.ts` они не имеют дефолтных значений. Если пользователь удалит их из `config.yaml`, приложение не запустится с ошибкой валидации вместо того, чтобы использовать разумное значение.

### Дублирование логики и констант
Значение `retryDelay` (3000мс) прописано и в `config.yaml`, и в `router.config.ts`. Это затрудняет поддержку.

---

## 3. Рекомендации по оптимизации

### Предлагаемые верхние лимиты
Для исключения ошибочных значений предлагаются следующие ограничения:

| Параметр | Рекомендуемый Max | Обоснование |
| :--- | :--- | :--- |
| `maxModelSwitches` | 10 | Перебор более 10 моделей обычно означает проблему в конфигурации. |
| `maxSameModelRetries` | 5 | Более 5 ретраев на одну модель при 429 ошибке обычно бессмысленны. |
| `retryDelay` | 30000 (30с) | Слишком большая задержка сделает HTTP-запрос неактуальным. |
| `timeoutSecs` | 600 (10м) | Верхний предел для тяжелых reasoning-моделей (o1 и т.д.). |
| `modelRequestsPerMinute`| 2000 | Лимит для защиты от аномальных всплесков трафика. |
| `max_tokens` | 128000 | Разумный предел для большинства современных моделей. |
| `failureThreshold` | 50 | Лимит для Circuit Breaker. |
| `cooldownPeriodMins` | 1440 (24ч)| Максимальное время блокировки модели. |

### Оптимизация для микросервиса (Single Instance, Medium Load)
Текущие значения в `config.yaml` в целом подобраны хорошо, но требуют небольших корректировок:
1.  **`timeoutSecs`**: Увеличить с 30 до 60-120 секунд. Современные модели (особенно через OpenRouter) могут отвечать долго.
2.  **`modelRequestsPerMinute`**: 100 — это очень консервативно для "средней нагрузки". Рекомендуется 200-500.

---

## 4. Реализованные улучшения

Все рекомендации были внедрены в проект:
1.  **Модификация `BaseValidator`:** Добавлена поддержка параметра `max` в метод `assertNumber`.
2.  **Обновление валидаторов конфигурации:** Проставлены верхние лимиты во всех классах-валидаторах.
3.  **Обновление DTO:** Добавлены декораторы `@Max()` в `ChatCompletionRequestDto`.
4.  **Добавление дефолтов в код:** Значения по умолчанию для всех полей `routing` теперь прописаны в `router.config.ts`.
5.  **Синхронизация с n8n:** Обновлены `typeOptions` в n8n node.
6.  **Оптимизация дефолтов:** `timeoutSecs` увеличен до 60с, `modelRequestsPerMinute` до 200.
